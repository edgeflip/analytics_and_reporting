<html>
<head>
    <script type="text/javascript" src="https://www.google.com/jsapi"></script>$
    <script type="text/javascript">
        google.load("visualization", "1.0", {"packages": ["table", "corechart"]});
        google.setOnLoadCallback(drawStuff);

        function drawStuff()
        {
            // turn all of the json strings that we get passed from our flask
            // app into JSON objects that can have their attributes accessed
            // nicely and those attributes parsed
            var today_json = '{{today_data}}';
            var aggregate_json = '{{aggregate_data}}';
            var all_json = '{{all_data}}';
            var day_json = '{{day_data}}';
            var hourly_json = '{{hourly_data}}';
            var monthly_json = '{{monthly_data}}';
            today_json = today_json.replace(/&#34;/ig, '"');
            today_json = JSON.parse(today_json);
            aggregate_json = aggregate_json.replace(/&#34;/ig, '"');
            aggregate_json = JSON.parse(aggregate_json);
            day_json = day_json.replace(/&#34;/ig, '"');
            day_json = JSON.parse(day_json);
            all_json = all_json.replace(/&#34;/ig, '"');
            all_json = JSON.parse(all_json);
            hourly_json = hourly_json.replace(/&#34;/ig, '"');
            hourly_json = JSON.parse(hourly_json);
            monthly_json = monthly_json.replace(/&#34;/ig, '"');
            monthly_json = JSON.parse(monthly_json);
            // create an array with our keys in it
            var all_keys = []
            for (name in all_json)
            {
                all_keys.push(name);
            }

            var all_campaigns = [];
            // We need to use the aggregate data json object because the day
            // and hour objects won't necessarily always have the campaign_ids
            for(i=0; i<all_keys.length; i++)
            {
                all_campaigns.push(all_json[all_keys[i]][0]);
            }
            

            // we need to sort the keys in descending order from 
            // most recently started campaign which we know the higher
            // the number the newer the campaign
            for(i=0; i<all_keys.length; i++)
            {
                for(j=0; j<all_keys.length-1;j++)
                {
                    if(parseInt(all_json[all_keys[j]][0],10) < parseInt(all_json[all_keys[j+1]][0],10))
                    {
                        var tmp = all_keys[j];
                        all_keys[j] = all_keys[j+1];
                        all_keys[j+1] = tmp;
                    }
                }
            }

            
            // create the first second that lists out our campaigns for this client
            var client = document.createElement('p');
            client.innerHTML = 'Campaigns Currently Running for Client <b>{{client_name}}</b>';
            var items = document.createElement('ul');
            for (i=0; i < all_keys.length; i++)
            {
                var cur = document.createElement('li');
                var cur_link = document.createElement('a');
                var cur_link_href = "#aggregate_campaign_{0}";
                cur_link_href = cur_link_href.replace('{0}', i.toString());
                cur_link.href = cur_link_href;
                cur_link.innerHTML = all_keys[i];
                cur.appendChild(cur_link);
                items.appendChild(cur);
            }
            document.body.appendChild(client);
            document.body.appendChild(items);
            document.body.appendChild(document.createElement('br'));
            document.body.appendChild(document.createElement('br'));
            document.body.appendChild(document.createElement('hr'));

            // AGGREGATE CAMPAIGN DISPLAY WITH ALL CAMPAIGNS INCLUDED
            // create the div to put it in
            var agg_div = document.createElement("div");
            agg_div.id = "agg_div";

            var Data = new google.visualization.DataTable();
            Data.addColumn('number', 'Visits');
            Data.addColumn('number', 'Clicks');
            Data.addColumn('number', 'Authorizations');
            Data.addColumn('number', 'Distinct Authorized Facebook Users');
            Data.addColumn('number', '# Users Shown Friends');
            Data.addColumn('number', '# Users Who Shared');
            Data.addColumn('number', '# Friends Shared With');
            Data.addColumn('number', '# Distint Friends Shared');
            Data.addColumn('number', 'Clickbacks');
            Data.addRows([aggregate_json.data]);

            var Aggregate_Table = new google.visualization.Table(agg_div);
            Aggregate_Table.draw(Data, {showRowNumberPosition: 'true', width:'100%', position: 'out'});


            // TODAY CAMPAIGN DISPLAY WITH ALL CAMPAIGNS INCLUDED
            var today_div = document.createElement("div");
            today_div.id = "today_div";

            var Data1 = new google.visualization.DataTable();
            Data1.addColumn('number', 'Visits');
            Data1.addColumn('number', 'Clicks');
            Data1.addColumn('number', 'Authorizations');
            Data1.addColumn('number', 'Distinct Authorized Facebook Users');
            Data1.addColumn('number', '# Users Shown Friends');
            Data1.addColumn('number', '# Users Who Shared');
            Data1.addColumn('number', '# Friends Shared With');
            Data1.addColumn('number', '# Distint Friends Shared');
            Data1.addColumn('number', 'Clickbacks');
            Data1.addRows([today_json.data]);

            var Today_Table = new google.visualization.Table(today_div);
            Today_Table.draw(Data1, {showRowNumberPosition: 'true', width: '100%', position: 'out'});

            // Add the div to the document that contains our Aggregate_Table
            var agg_title = document.createElement("p");
            agg_title.innerHTML = "Aggregate Data for All Campaigns";
            document.body.appendChild(agg_title);
            document.body.appendChild(agg_div);
            document.body.appendChild(document.createElement('br'));
            var today_title = document.createElement("p");
            today_title.innerHTML = "Data for All Campaigns for {{today}}";
            document.body.appendChild(today_title);
            document.body.appendChild(today_div);
            document.body.appendChild(document.createElement('br'));
            document.body.appendChild(document.createElement('br'));
            document.body.appendChild(document.createElement('hr'));
            
            
            for(i = 0; i < all_keys.length; i++)
            {
                // for each key in our keys array create divs for the aggregate
                // and for the daily data
                var div = "aggregate_campaign_{0}";
                var div1 = "daily_campaign_{0}";
                var div2 = "hourly_campaign_{0}";
                var div3 = "monthly_campaign_{0}";

                // associate each div with the iteration we are on allowing
                // for a dynamic amount of divs to be created in turn
                // allowing for a dynamic number of tables and charts
                // to be displayed for our clients

                div = div.replace('{0}', i.toString());
                div1 = div1.replace('{0}', i.toString());
                div2 = div2.replace('{0}', i.toString());
                div3 = div3.replace('{0}', i.toString());
                var new_div = document.createElement("div");
                var new_div1 = document.createElement("div");
                var new_div2 = document.createElement("div");
                var new_div3 = document.createElement("div");
                new_div.id = div;
                new_div1.id = div1;
                new_div2.id = div2;
                //new_div2.style.width = "800px";

                new_div3.id = div3;
                //new_div3.style.width = "800px";

                // The div we just created for this campaign is the div
                // we will use to create our data table
                var data = new google.visualization.DataTable();
                data.addColumn('number', 'Visits');
                data.addColumn('number', 'Clicks');
                data.addColumn('number', 'Authorizations');
                data.addColumn('number', 'Distinct Authorized Facebook Users');
                data.addColumn('number', '# Users Shown Friends');
                data.addColumn('number', '# Users Who Shared');
                data.addColumn('number', '# Friends Shared With');
                data.addColumn('number', '# Distint Friends Shared');
                data.addColumn('number', 'Clickbacks');
                //var title = {title: keys[i]};
                var this_data = all_json[all_keys[i]].slice(1,all_json[all_keys[i]].length);
                data.addRows([this_data]);
                var table = new google.visualization.Table(new_div);
                table.draw(data, {title: all_keys[i]});

                var data1 = new google.visualization.DataTable();
                data1.addColumn('number', 'Visits');
                data1.addColumn('number', 'Clicks');
                data1.addColumn('number', 'Authorizations');
                data1.addColumn('number', 'Distinct Authorized Facebook Users');
                data1.addColumn('number', '# Users Shown Friends');
                data1.addColumn('number', '# Users Who Shared');
                data1.addColumn('number', '# Friends Shared With');
                data1.addColumn('number', '# Distint Friends Shared');
                data1.addColumn('number', 'Clickbacks');
                var this_data1 = day_json[all_keys[i]].slice(1,day_json[all_keys[i]].length); 
                data1.addRows([this_data1]);
                var table1 = new google.visualization.Table(new_div1);
                table1.draw(data1, {title: all_keys[i]});


                // Line Charts for hourly graphs using the the hourly_json object
                // we defined from above
                var line1_array = new Array();
                line1_array[0] = ['Hour', 'Visits', 'Clicks', 'Authorizations', 'Distinct Authorized Facebook Users', '# Users Shown Friends', '# Users Who Shared', '# Friends Shared With', '# Distinct Friends Shared', 'Clickbacks'];
                for(w=0; w < hourly_json[all_keys[i]].length; w++)
                {
                    line1_array[w+1] = hourly_json[all_keys[i]][w];
                }
                var line1_chart_data = google.visualization.arrayToDataTable(line1_array);
                var line1_options = {title: 'Hourly Report', fontSize: '10', enableInteractivity: 'true', 'width': 1000};
                var line1 = new google.visualization.LineChart(new_div2);
                line1.draw(line1_chart_data, line1_options);


                // Line Chart for the monthly graphs using the monthly_json
                // Object we defined at the top

                var line2 = new google.visualization.DataTable();
                line2.addColumn('date', 'Date');
                line2.addColumn('number', 'Visits');
                line2.addColumn('number', 'Clicks');
                line2.addColumn('number', 'Auths');
                line2.addColumn('number', 'Distinct Facebook Auths');
                line2.addColumn('number', '# Users Shown Friends');
                line2.addColumn('number', '# Users Who Shared');
                line2.addColumn('number', '# Friends Shared With');
                line2.addColumn('number', '# Distinct Friends Shared');
                line2.addColumn('number', 'Clickbacks');
                var arr2 = new Array();
                
                for(j=0; j < monthly_json[all_keys[i]].length; j++)
                {
                    var date_bits = monthly_json[all_keys[i]][j][0].split(/\D/);
                    var _date = [new Date(date_bits[0], date_bits[1]-1, date_bits[2])];
                    arr2[j] = _date.concat(monthly_json[all_keys[i]][j].slice(1, monthly_json[all_keys[i]][j].length));
                
                }

                line2.addRows(arr2);
                var line2opt = {title: 'Daily Report(for last 30 days)', fontSize: '10', 'width': 1000};
                var chart2 = new google.visualization.LineChart(new_div3);
                chart2.draw(line2, line2opt);
                    


                // Adding all non-existent titles to their respective tables/charts
                // After adding the titles binding the div elements that contain our tables
                // and line charts to the html DOM.

                var title = document.createElement('p');
                title.innerHTML = '<h3>' + all_keys[i] + '</h3>';
                var all_data_disclaimer = document.createElement('p');
                all_data_disclaimer.innerHTML = "Data From Beginning of Campaign to <b>{{today}}</b>";
                var day_data_disclaimer = document.createElement('p');
                day_data_disclaimer.innerHTML = "Data for <b>{{today}}</b>";
               
                document.body.appendChild(title);
                document.body.appendChild(all_data_disclaimer);
                document.body.appendChild(new_div);
                document.body.appendChild(day_data_disclaimer);
                document.body.appendChild(new_div1);
                document.body.appendChild(new_div2);
                document.body.appendChild(new_div3);
                document.body.appendChild(document.createElement('hr'));
                document.body.appendChild(document.createElement('br'));
                document.body.appendChild(document.createElement('br'));
              
            }
            
        }
     </script>
</head>
<body>
    <p style="color:red">{{error}}</p>
</body>
</html>
